unit TestADSchemaUnit;
{

  Delphi DUnit Test Case
  ----------------------
  This unit contains a skeleton test case class generated by the Test Case Wizard.
  Modify the generated code to correctly setup and call the methods from the unit 
  being tested.

}

interface

uses
  TestFramework, ADSchemaHelpUnit, Classes, Windows, ADSchemaTypes, LDAPClientUnit, 
  SysUtils, ADSchemaUnit;
type
  // Test methods for class ADSchema
  
  TestADSchema = class(TTestCase)
  strict private
    FADSchema: ADSchema;
    TestPassword: string;
    TestUserDN: string;
    TestPortNumber: Integer;
    TestHostName: string;
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure TestConnect;
    procedure TestDisconnect;
    procedure TestGetEntry;
    procedure TestGetEntry1;
    procedure TestGetAll;
    procedure TestGetAll1;
    procedure TestGetEntries;
    procedure TestAddEntry;
    procedure TestModifyEntryAttributes;
    procedure TestDeleteEntryAttributes;
    procedure TestDeleteEntryAttributes1;
  end;

implementation

procedure TestADSchema.SetUp;
begin
  FADSchema := ADSchema.Create;
  TestPortNumber := 389;
  TestHostName := 'starkyli-1sqlu0.domain.local';
  TestPassword := 'pa$$w0rd';
  //userDN := 'CN=Ilshat,CN=Users,DC=domain,DC=local';
  TestUserDN := 'starkylife@domain.local';
end;

procedure TestADSchema.TearDown;
begin
  FADSchema.Free;
  FADSchema := nil;
end;

procedure TestADSchema.TestConnect;
var
  status: ADSchemaStatus;
  portNumber: Integer;
  password: string;
  userName: string;
  hostName: string;
begin
  // Setup method call parameters

  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  FADSchema.Disconnect;
  // Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestDisconnect;
begin
  FADSchema.Disconnect;
  // TODO: Validate method results
end;

procedure TestADSchema.TestGetEntry;
var
  ReturnValue: ADEntry;
  status: ADSchemaStatus;
  entrType: EntryType;
  CNname: string;
begin
  CNname := 'account';
  entrType := ClassEntry;

  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.GetEntry(CNname, entrType, status);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestGetEntry1;
var
  ReturnValue: ADEntry;
  status: ADSchemaStatus;
  withAttr: array of string;
  entrType: EntryType;
  CNname: string;
begin
  CNname := 'account';
  entrType := ClassEntry;
  SetLength(withAttr, 1);
  withAttr[0] := 'mustContain';

  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.GetEntry(CNname, entrType, withAttr, status);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestGetAll;
var
  ReturnValue: ADEntryList;
  status: ADSchemaStatus;
  entrType: EntryType;
begin
  entrType := ClassEntry;

  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.GetAll(entrType, status);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestGetAll1;
var
  ReturnValue: ADEntryList;
  status: ADSchemaStatus;
  withAttr: array of string;
  entrType: EntryType;
begin
  entrType := ClassEntry;
  SetLength(withAttr, 1);
  withAttr[0] := 'cn';

  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.GetAll(entrType, withAttr, status);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestGetEntries;
var
  ReturnValue: ADEntryList;
  status: ADSchemaStatus;
  withAttr: array of string;
  filter: string;
begin
  SetLength(withAttr, 1);
  withAttr[0] := 'cn';
  filter := '(objectClass=classSchema)';
  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.GetEntries(filter, withAttr, status);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, status.StatusNumb, status.StatusMsg);
end;

procedure TestADSchema.TestAddEntry;
var
  ReturnValue: ADSchemaStatus;
  newEntry: ADEntry;
  status: ADSchemaStatus;
begin
  newEntry := ADEntry.Create('MyTest');
  newEntry.AddAttribute('cn', ['MyTest']);
  newEntry.AddAttribute('objectClass', ['classSchema']);
  newEntry.AddAttribute('governsID', ['1.2.840.113556.1.8000.2554.13844.27782.13802.18569.40486.16667616.15992124']);
  newEntry.AddAttribute('subClassOf', ['top']);
  //newEntry.AddAttribute('schemaIDGUID', ['msQ0lJ2zl0WpJ14JF3Quzw==']);
  //newEntry.AddAttribute('defaultObjectCategory', ['CN=justTestClass,CN=Schema,CN=Configuration,DC=domain,DC=local']);
  newEntry.AddAttribute('objectClassCategory', ['0']);
  //newEntry.addAttribute('instanceType', ['4']);
  newEntry.AddAttribute('lDAPDisplayName', ['MyTest']);
  //newEntry.AddAttribute('objectCategory', ['CN=Class-Schema,CN=Schema,CN=Configuration,DC=domain,DC=local']);

  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.AddEntry(newEntry);
  FADSchema.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, ReturnValue.StatusNumb, ReturnValue.StatusMsg);
end;

procedure TestADSchema.TestModifyEntryAttributes;
var
  ReturnValue: ADSchemaStatus;
  modifiedEntry: ADEntry;
  status: ADSchemaStatus;
begin
  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.ModifyEntryAttributes(modifiedEntry);
  FADSchema.Disconnect;
  // TODO: Validate method results
end;

procedure TestADSchema.TestDeleteEntryAttributes;
var
  ReturnValue: ADSchemaStatus;
  entryWithDeleteAttributes: ADEntry;
  status: ADSchemaStatus;
begin
  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.DeleteEntryAttributes(entryWithDeleteAttributes);
  FADSchema.Disconnect;
  // TODO: Validate method results
end;

procedure TestADSchema.TestDeleteEntryAttributes1;
var
  ReturnValue: ADSchemaStatus;
  attrToDelete: array of string;
  name: string;
  status: ADSchemaStatus;
begin
  // TODO: Setup method call parameters
  FADSchema.Connect(TestHostName, TestUserDN, TestPassword, TestPortNumber, status);
  status.Free;
  status := nil;
  ReturnValue := FADSchema.DeleteEntryAttributes(name, attrToDelete);
  FADSchema.Disconnect;
  // TODO: Validate method results
end;

initialization
  // Register any test cases with the test runner
  RegisterTest(TestADSchema.Suite);
end.

