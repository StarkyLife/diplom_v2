unit TestLDAPClientUnit;
{

  Delphi DUnit Test Case
  ----------------------
  This unit contains a skeleton test case class generated by the Test Case Wizard.
  Modify the generated code to correctly setup and call the methods from the unit 
  being tested.

}

interface

uses
  TestFramework, Windows, SysUtils, Classes, LDAPClientUnit;
type
  // Test methods for class LDAPClient
  
  TestLDAPClient = class(TTestCase)
  strict private
    FLDAPClient: LDAPClient;
    TestPassword: string;
    TestUserDN: string;
    TestPortNumber: Integer;
    TestHostName: string;
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure TestInit;
    procedure TestConnectSimple;
    procedure TestDisconnect;
    procedure TestSearch;
    procedure TestAddEntry;
    procedure TestModifyEntry;
    procedure TestDeleteEntry;
    procedure TestCompareAttributeValue;
  end;

implementation

procedure TestLDAPClient.SetUp;
begin
  FLDAPClient := LDAPClient.Create;
  TestPortNumber := 389;
  TestHostName := 'starkyli-1sqlu0.domain.local';
  TestPassword := 'pa$$w0rd';
  //userDN := 'CN=Ilshat,CN=Users,DC=domain,DC=local';
  TestUserDN := 'starkylife@domain.local';
end;

procedure TestLDAPClient.TearDown;
begin
  FLDAPClient.Free;
  FLDAPClient := nil;
end;

procedure TestLDAPClient.TestInit;
var
  ReturnValue: LDAPClientStatus;
  portNumber: Integer;
  hostName: string;
begin
  // TODO: Setup method call parameters
  portNumber := 389;
  hostName := 'starkyli-1sqlu0.domain.local';
  ReturnValue := FLDAPClient.Init(hostName, portNumber);

  // TODO: Validate method results
  CheckEquals(0, ReturnValue.numb, ReturnValue.msg);
end;

procedure TestLDAPClient.TestConnectSimple;
var
  ReturnValue: LDAPClientStatus;
  password: string;
  userDN: string;
begin
  // TODO: Setup method call parameters
  password := 'pa$$w0rd';
  //userDN := 'CN=Ilshat,CN=Users,DC=domain,DC=local';
  userDN := 'starkylife@domain.local';
  FLDAPClient.Init(TestHostName, TestPortNumber);
  ReturnValue := FLDAPClient.ConnectSimple(userDN, password);
  FLDAPClient.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, ReturnValue.numb, ReturnValue.msg);
end;

procedure TestLDAPClient.TestDisconnect;
begin
  FLDAPClient.Disconnect;
  // TODO: Validate method results   
end;

procedure TestLDAPClient.TestSearch;
var
  ReturnValue: LDAPClientStatus;
  searchResult: SearchDataType;
  attr: array of LDAPAttribute;
  filter: string;
  catalogDN: string;
  test : string;
  
begin
  // TODO: Setup method call parameters
  catalogDN := 'CN=account,CN=Schema,CN=Configuration,DC=domain,DC=local';
  filter := '(objectClass=classSchema)';
  SetLength(attr,2);
  attr[0] := LDAPAttribute.Create(1);
  attr[0].Name := 'cn';
  attr[1] := LDAPAttribute.Create(1);
  attr[1].Name := 'mayContain';    

  FLDAPClient.Init(TestHostName, TestPortNumber);
  FLDAPClient.ConnectSimple(TestUserDN, TestPassword);
  ReturnValue := FLDAPClient.Search(catalogDN, filter, attr, searchResult);
  FLDAPClient.Disconnect;             

  test := LDAPAttribute(searchResult[0][0]).Value[0];
  // TODO: Validate method results
  CheckEquals('account',
               LDAPAttribute(searchResult[0][0]).Value[0],
               'Something wrong with returned search data!');
  CheckEquals(0, ReturnValue.numb, ReturnValue.msg);

end;

procedure TestLDAPClient.TestAddEntry;
var
  ReturnValue: LDAPClientStatus;
  attr: array of LDAPAttribute;
  entryDN: string;
begin
  // TODO: Setup method call parameters

  //Test Entry Data 1
  {entryDN := 'cn=JeffFirst,CN=Users,DC=domain,DC=local';
  SetLength(attr, 3);
  attr[0] := LDAPAttribute.Create(1);
  attr[0].Name := 'cn';
  attr[0].Value[0] := 'JeffFirst';
  attr[1] := LDAPAttribute.Create(1);
  attr[1].Name := 'objectClass';
  attr[1].Value[0] := 'user';
  attr[2] := LDAPAttribute.Create(1);
  attr[2].Name := 'title';
  attr[2].Value[0] := 'Developer';    }

  //Test Entry Data 2
  entryDN := 'cn=LDAPClientTest,CN=Users,DC=domain,DC=local';
  SetLength(attr, 3);
  attr[0] := LDAPAttribute.Create(1);
  attr[0].Name := 'cn';
  attr[0].Value[0] := 'LDAPClientTest';
  attr[1] := LDAPAttribute.Create(1);
  attr[1].Name := 'objectClass';
  attr[1].Value[0] := 'user';
  attr[2] := LDAPAttribute.Create(1);
  attr[2].Name := 'title';
  attr[2].Value[0] := 'Test Object';

  FLDAPClient.Init(TestHostName, TestPortNumber);
  FLDAPClient.ConnectSimple(TestUserDN, TestPassword);
  ReturnValue := FLDAPClient.AddEntry(entryDN, attr);
  FLDAPClient.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, ReturnValue.numb, ReturnValue.msg);
end;

procedure TestLDAPClient.TestModifyEntry;
var
  ReturnValue: LDAPClientStatus;
  modifyType: Integer;
  attrToModify: array of LDAPAttribute;
  entryDN: string;
begin
  // TODO: Setup method call parameters
  // Replace test
  entryDN := 'CN=LDAPClientTest,CN=Users,DC=domain,DC=local';
  modifyType := MODIFY_TYPE_REPLACE;

  SetLength(attrToModify,2);
  attrToModify[0] := LDAPAttribute.Create(1);
  attrToModify[0].Name := 'title';
  attrToModify[0].Value[0] := 'title after modify';
  attrToModify[1] := LDAPAttribute.Create(1);
  attrToModify[1].Name := 'mail';
  attrToModify[1].Value[0] := 'ilshat.ismagilov2014@gmail.com'; 

  // Delete test
  {entryDN := 'CN=Jeff0,CN=Users,DC=domain,DC=local';
  modifyType := MODIFY_TYPE_DELETE;

  SetLength(attrToModify,2);
  attrToModify[0] := LDAPAttribute.Create(1);
  attrToModify[0].Name := 'title';
  attrToModify[1] := LDAPAttribute.Create(1);
  attrToModify[1].Name := 'mail';  }

  FLDAPClient.Init(TestHostName, TestPortNumber);
  FLDAPClient.ConnectSimple(TestUserDN, TestPassword);  
  ReturnValue := FLDAPClient.ModifyEntry(entryDN, attrToModify, modifyType);
  FLDAPClient.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, ReturnValue.numb, ReturnValue.msg);
end;

procedure TestLDAPClient.TestDeleteEntry;
var
  ReturnValue: LDAPClientStatus;
  entryDN: string;
begin
  // TODO: Setup method call parameters
  entryDN := 'CN=LDAPClientTest,CN=Users,DC=domain,DC=local';

  FLDAPClient.Init(TestHostName, TestPortNumber);
  FLDAPClient.ConnectSimple(TestUserDN, TestPassword);
  ReturnValue := FLDAPClient.DeleteEntry(entryDN);
  FLDAPClient.Disconnect;
  // TODO: Validate method results
  CheckEquals(0, returnValue.numb, ReturnValue.msg);
end;

procedure TestLDAPClient.TestCompareAttributeValue;
var
  ReturnValue: LDAPClientStatus;
  attrValueToCompare: string;
  attrName: string;
  entryDN: string;
begin
  // TODO: Setup method call parameters
  entryDN := 'CN=account,CN=Schema,CN=Configuration,DC=domain,DC=local';
  attrName := 'cn';
  attrValueToCompare := 'account';

  ReturnValue := FLDAPClient.CompareAttributeValue(entryDN, attrName, attrValueToCompare);
  // TODO: Validate method results
end;

initialization
  // Register any test cases with the test runner
  RegisterTest(TestLDAPClient.Suite);
end.

